import os
import streamlit as st
import openai

# --- APIã‚­ãƒ¼è¨­å®š ---
api_key = st.secrets.get("OPENAI_API_KEY") or os.getenv("OPENAI_API_KEY")
openai.api_key = api_key

# --- Streamlit ã‚¢ãƒ—ãƒªè¨­å®š ---
st.title("ğŸ—ï¸ å»ºè¨­æ¥­ç•Œå°‚é–€ LLMã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼")
st.write("""
ã“ã®ã‚¢ãƒ—ãƒªã§ã¯ã€å»ºè¨­æ¥­ã«ç‰¹åŒ–ã—ãŸ3ã‚¿ã‚¤ãƒ—ã®å°‚é–€AIãŒã‚ãªãŸã®è³ªå•ã«ç­”ãˆã¾ã™ã€‚  
å·¦ã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã§å°‚é–€é ˜åŸŸã‚’é¸ã³ã€è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
""")

# --- å°‚é–€å®¶ã®ç¨®é¡ã‚’é¸æŠ ---
expert = st.radio(
    "ç›¸è«‡ã—ãŸã„å°‚é–€å®¶ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š",
    ("æ–½å·¥ç®¡ç†æŠ€å£«", "å»ºç¯‰è¨­è¨ˆå£«", "å»ºè¨­çµŒå–¶ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ")
)

# --- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  ---
user_input = st.text_area("ğŸ’¬ è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šç¾å ´ã®å®‰å…¨ç®¡ç†ã‚’æ”¹å–„ã—ãŸã„ ãªã©ï¼‰")

# --- ChatGPT APIå‘¼ã³å‡ºã—é–¢æ•° ---
def get_openai_response(role, text):
    if not api_key:
        return "âš ï¸ APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"

    if role == "æ–½å·¥ç®¡ç†æŠ€å£«":
        system_prompt = (
            "ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªæ–½å·¥ç®¡ç†æŠ€å£«ã§ã™ã€‚"
            "ç¾å ´ã®å®‰å…¨ç®¡ç†ãƒ»å“è³ªãƒ»ã‚³ã‚¹ãƒˆã«é–¢ã™ã‚‹èª²é¡Œã«ã€å®Ÿå‹™çš„ã‹ã¤å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã—ã¦ãã ã•ã„ã€‚"
        )
    elif role == "å»ºç¯‰è¨­è¨ˆå£«":
        system_prompt = (
            "ã‚ãªãŸã¯å„ªç§€ãªå»ºç¯‰è¨­è¨ˆå£«ã§ã™ã€‚"
            "è¨­è¨ˆãƒ»æ§‹é€ ãƒ»æ³•è¦ãƒ»ç’°å¢ƒè¨­è¨ˆãªã©ã®è¦³ç‚¹ã‹ã‚‰ã€æŠ€è¡“çš„ã§å‰µé€ çš„ãªåŠ©è¨€ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚"
        )
    else:
        system_prompt = (
            "ã‚ãªãŸã¯å»ºè¨­æ¥­çµŒå–¶å°‚é–€ã®çµŒå–¶ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆã§ã™ã€‚"
            "äººæä¸è¶³ãƒ»åŸä¾¡ç®¡ç†ãƒ»å…¥æœ­æˆ¦ç•¥ãƒ»DXåŒ–ãªã©çµŒå–¶é¢ã‹ã‚‰ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã—ã¦ãã ã•ã„ã€‚"
        )

    try:
        completion = openai.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": text},
            ],
        )
        return completion.choices[0].message.content
    except Exception as e:
        return f"âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}"

# --- ãƒœã‚¿ãƒ³æ“ä½œ ---
if st.button("å›ç­”ã‚’è¡¨ç¤º"):
    if user_input.strip():
        st.markdown("### ğŸ’¡ å›ç­”ï¼š")
        st.write(get_openai_response(expert, user_input))
    else:
        st.warning("è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")

# --- ãƒ•ãƒƒã‚¿ãƒ¼ ---
st.caption("ver. 2025-10-28 / LangChainéä¾å­˜ãƒ»å®‰å®šç¨¼åƒç‰ˆ")
